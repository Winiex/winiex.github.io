<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Hadoop 中的 Configuration · Bach is coding</title><meta name="description" content="Hadoop 中的 Configuration - winiex"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/winiex" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Hadoop 中的 Configuration</h1><div class="post-info">Jun 10, 2016</div><div class="post-content"><h2 id="序"><a href="#序" class="headerlink" title="序"></a>序</h2><p>从这篇文章开始，我将把自己对 Hadoop 系统的一些学习经验整理成文章分享出来，算是对自己学习过程的梳理和知识的分享。我主要会从源代码的角度去探索 Hadoop 中的各个组件的技术细节，使用的是 <a href="https://github.com/apache/hadoop/tree/branch-2.7.2" target="_blank" rel="external">2.7.2</a> 的源代码。</p>
<p>一个成熟的软件系统必备的组件之一就是配置系统。配置系统负责将纷繁复杂的配置项按照一定的既定规则管理起来，从而让系统的其他组件不必重复处理类似于配置加载、配置 Override、扩展配置字段中的引用符号等细节。我所熟悉的 Tornado、Django、Laravel 等 Web 框架都会有一套自己严格规定的配置系统；这也引导了我平时新开一个项目的时候，第一时间着手实现的就是配置管理模块——这是因为我相信配置管理被成熟地实现会避免一系列问题（尤其是部署过程中的）。久而久之，在 Python Web 开发领域我已经有了自己的一套「最佳实践」——配置存储于 JSON、YAML 文件，使用脚本将内容映射为 Python 模块对象，使用时直接导入变量即可，而配置文件本身本地、开发机与线上各自保存一份，与代码部署过程分离（这样可以避免本地的、开发机器上的或生产环境的配置文件随频率更高的代码部署流程误部署）。大型系统甚至会衍生出自己的配置管理服务（例如<a href="http://www.infoq.com/cn/articles/weibao-config-service-practice" target="_blank" rel="external">微博的实践</a>）来应对日益复杂的配置管理工作，而开源社区也贡献了 <a href="https://coreos.com/etcd/" target="_blank" rel="external">etcd</a> 这种优秀的解决方案。</p>
<p>Hadoop 中的配置系统和我前述的自己的「最佳实践」的做法类似——数据主要存储于 XML 文件中，由 <a href="https://hadoop.apache.org/docs/r2.7.2/api/org/apache/hadoop/conf/Configuration.html" target="_blank" rel="external">org.hadoop.conf.Configuration</a> 类负责配置加载、Override、字段扩展等工作，每个 Hadoop 组件在启动后都会拥有自己的 Configuration 实例（最常见的就是 MapReduce 2 程序中你在 job 代码的 main 方法里 new 的那个），需要获取或者设置某个配置字段时只需要调用相应的方法即可。这种做法在 Java 社区比较常见，Tomcat、Spring 等知名 Java 项目都采用了类似的方案。</p>
<a id="more"></a>
<h2 id="Configuration-简介"><a href="#Configuration-简介" class="headerlink" title="Configuration 简介"></a>Configuration 简介</h2><p>下面我们对 Configuration 的一些基本功能做一些介绍。</p>
<h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><p><code>深入了解一段代码的原理从了解其接口开始，了解其接口则从会使用它开始</code>。下面是一段 Configuration 使用的实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bachiscoding.hadoop.lab.conf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by winiex on 16-6-10.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicUsage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. Configuration 对象是可以直接实例化的</span></span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 通过调用 addResource 方法来将配置资源注册到 Configuration</span></span><br><span class="line">        <span class="comment">// 对象中，这个时候 Configuration 对象内还没有加载配置中的内容</span></span><br><span class="line">        configuration.addResource(<span class="string">"conf/hdfs-default.xml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 通过调用 get 方法来获取配置项转化为 String 类型后的值</span></span><br><span class="line">        String value1 = configuration.get(<span class="string">"dfs.datanode.address"</span>);</span><br><span class="line">        System.out.println(value1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 可以通过 set 方法来设置配置项的值，值的类型为 String</span></span><br><span class="line">        configuration.set(<span class="string">"dfs.datanode.address"</span>, <span class="string">"New Value"</span>);</span><br><span class="line">        value1 = configuration.get(<span class="string">"dfs.datanode.address"</span>);</span><br><span class="line">        System.out.println(value1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 也可以指定要获取的配置项值的类型，对应的值会被转化为相应的类型的实例</span></span><br><span class="line">        <span class="keyword">int</span> value2 = configuration.getInt(<span class="string">"hadoop.hdfs.configuration.version"</span>, <span class="number">1</span>);</span><br><span class="line">        System.out.println(value2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 设置配置项的值时也可以制定类型</span></span><br><span class="line">        configuration.setInt(<span class="string">"hadoop.hdfs.configuration.version"</span>, <span class="number">2</span>);</span><br><span class="line">        value2 = configuration.getInt(<span class="string">"hadoop.hdfs.configuration.version"</span>, <span class="number">1</span>);</span><br><span class="line">        System.out.println(value2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中存储配置数据的 <code>hdfs-default.xml</code> 文件是一个保存在某个 Java Classpath 中的 conf 目录下的 XML 文件，其结构如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.hdfs.configuration.version<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>version of this configuration file<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>0.0.0.0:50010<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">      The datanode server address and port for data transfer.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span>&gt;</span>Application<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 在结构上 Configuration 可以嵌套，最终的值会会和上面的解析在一起，本质上没有区别 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.hdfs.configuration.version<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">description</span>&gt;</span>version of this configuration file<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span>Testing<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>有 Hadoop 使用经验的朋友应该遇到过程序找不到配置文件的错误，这是因为打包时没有把相应的 XML 配置文件放到 Jar 文件的 resources 目录下或者运行程序时没有包含配置所在的路径到 JVM 的 Classpath 中去。对于  String 类型的 Resource，Configuration 会在加载配置时根据它的值到 Classpath 中去寻找相应的文件，这一块后面我们分析加载配置数据的部分的代码时会涉及到。对于刚才的例子，如果是用 Maven 打包的程序，配置文件可以放到下图所示的目录下：</p>
<p><img src="http://o9fv3ui6e.bkt.clouddn.com/0b6e0368-3c88-11e6-8e75-072ca02ef1c5.png" alt="Where to place config files"></p>
<p>在 MapReduce 程序中 Configuration 的样例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ......</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenizerMapper</span></span><br><span class="line">       <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt;</span>&#123;</span><br><span class="line">         ......</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntSumReducer</span></span><br><span class="line">       <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">         ......</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">    Job job = Job.getInstance(conf, <span class="string">"word count"</span>);</span><br><span class="line">    conf.setInt(<span class="string">"param1"</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 MapReduce 程序运行的过程中，这个 Configuration 对象会被通过 Hadoop 的序列化机制共享到各个角色中（Mapper、Combiner、Reducer 等），这样各个角色都能够通过它获得该 MapReduce 程序的配置数据，代码里面设置的 param1 在各个角色里面都可以获取到。</p>
<h3 id="配置的可覆盖性"><a href="#配置的可覆盖性" class="headerlink" title="配置的可覆盖性"></a>配置的可覆盖性</h3><p>使用过 Hadoop 的朋友应该会知道，如果在运行 MapReduce 程序的时候，在命令行参数中加入 <code>-D</code> 参数，是可以制定甚至覆盖掉某个配置项的值的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar wordcount.jar -Dfoo=bar <span class="comment">#这样在 wordcount 运行的过程中，Configuration 对象会包含 foo = bar 这一配置项</span></span><br></pre></td></tr></table></figure>
<p>这种配置的可覆盖性是 Configuration 提供的一种方便开发的机制，通过运行程序是手动指定配置项，我们可以方便地去定制 Job 的一些基本环境，例如容器虚拟 CPU 个数、容器堆内存大小等。我之前遇到过某个 Job 总是因为默认的容器堆内存过小被 Kill 掉的问题，最后就是通过手动指定更大的容器堆内存来解决的。</p>
<h3 id="不可被覆盖的-final-配置"><a href="#不可被覆盖的-final-配置" class="headerlink" title="不可被覆盖的 final 配置"></a>不可被覆盖的 final 配置</h3><p>参数默认情况下是可以被覆盖的，但有些参数我们也是希望我们指定了其他人就不能覆盖了。这个时候可以使用 final 属性来达到目的：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.ssl.client.conf<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>ssl-client.xml<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">final</span>&gt;</span>true<span class="tag">&lt;/<span class="name">final</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>指定了 final 属性为 true 后，其他人就不能通过覆盖的方式改变它的值了。如果要强行覆盖该配置的话，你指定的值不会起作用，而且 Configuration 会在 Log 中输出 Warning 信息。</p>
<h3 id="配置的扩展"><a href="#配置的扩展" class="headerlink" title="配置的扩展"></a>配置的扩展</h3><p>在某些场景下，我们的某个配置项是依赖于另一个配置项的，这个时候如果配置项能够按照引用的方式来扩展就会很方便。Configuration 提供了这个机制，我们最熟悉的例子是 hadoop.tmp.dir 和 dfs.datanode.data.dir：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/tmp/hadoop<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>file://$&#123;hadoop.tmp.dir&#125;/dfs/data<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们看到，dfs.datanode.data.dir 的值中用 <code>${KEY_NAME}</code> 的形式引用了 hadoop.tmp.dir 的值。在 Configuration 获取 dfs.datanode.data.dir 的值时，会将该部分替换为 hadoop.tmp.dir 的值，最终结果为 /tmp/hadoop/dfs/data。这个配置扩展的机制类似于 Bash 脚本中引用某个变量。</p>
<p>接下来我们来了解一下 Configuration 的结构。</p>
<h2 id="Configuration-的结构"><a href="#Configuration-的结构" class="headerlink" title="Configuration 的结构"></a>Configuration 的结构</h2><p>简化后的 Configuration 类的 UML 结构图如下：</p>
<p><img src="http://o9fv3ui6e.bkt.clouddn.com/f2184b04-4393-11e6-b240-0f5eada557cc.svg" alt="UML Class Diagram of Configuration"></p>
<p>Configuration 实现了 <a href="http://hadoop.apache.org/docs/current/api/org/apache/hadoop/io/Writable.html" target="_blank" rel="external">org.apache.hadoop.io.Writable</a> 接口和 Iterator 接口。实现前者的目的是为了让 Configuration 能够利用到 Hadoop 的序列化机制，从而能够在系统内不同服务角色上传输、共享。实现后者的目的是为了让我们能够用<a href="https://en.wikipedia.org/wiki/Iterator_pattern" target="_blank" rel="external">迭代器模式</a>来访问 Configuration 内的配置项：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bachiscoding.hadoop.lab.conf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by winiex on 16-7-2.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IterateConf</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">        configuration.addResource(<span class="string">"conf/hdfs-default.xml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得 Configuration 对象的迭代器对象</span></span><br><span class="line">        Iterator&lt;Map.Entry&lt;String, String&gt;&gt; confIter = configuration.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (confIter.hasNext()) &#123;</span><br><span class="line">            Map.Entry&lt;String, String&gt; entry = confIter.next();</span><br><span class="line">            String key = entry.getKey();</span><br><span class="line">            String value = entry.getValue();</span><br><span class="line"></span><br><span class="line">            System.out.println(key);</span><br><span class="line">            System.out.println(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Configuration 中很大一部分方法是以 get/set 来开头的，这个做法 Java 程序员不会陌生。只让调用者通过这些方法来访问 Configuration 的配置数据，可以封装掉底层的实现细节（例如后面会介绍的 Lazy Loading 机制），让 API 变得一致，让开发变得简单好维护。</p>
<p>Configuration 需要一个保存配置项数据的地方，它就是 UML 类图中的 properties 成员变量，它是一个 <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Properties.html" target="_blank" rel="external">java.util.Properties</a> 对象。Configuration 加载配置资源的内容后会将处理完毕的配置项的数值保存在 properties 里面。</p>
<p>resources 成员变量是一个包含了 Resource 类的 ArrayList，它记录了 Configuration 对象有哪些配置资源需要加载。而 Resource 是 Configuration 内私有的一个类型，代表了一个配置资源。Configuration 支持的配置资源有：「字符串」（存在于 CLASSPATH 中的资源）、「URL」、「Path」（存在于 HDFS 中的配置文件）、「InputStream」和「另一个 Configuration」。</p>
<h2 id="Configuration-源码分析"><a href="#Configuration-源码分析" class="headerlink" title="Configuration 源码分析"></a>Configuration 源码分析</h2><p>下面我们在代码层面从几个方面详细地了解其工作机理。</p>
<h3 id="初始化过程"><a href="#初始化过程" class="headerlink" title="初始化过程"></a>初始化过程</h3><p>初始化一个 Configuration 最简单的方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Configuration configuration = <span class="keyword">new</span> Configuration();</span><br></pre></td></tr></table></figure>
<p>我们都知道，在 JVM 初始化一个 <code>类</code> (注意，不是实例)时，会最先执行类内部的 static 代码块，来完成一些属于类的初始化工作。在 Configuration 中就通过这个方式，用一段 static 代码块注册了默认配置文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span>&#123;</span><br><span class="line">  <span class="comment">//print deprecation warning if hadoop-site.xml is found in classpath</span></span><br><span class="line">  <span class="comment">// 获取 ClassLoader</span></span><br><span class="line">  ClassLoader cL = Thread.currentThread().getContextClassLoader();</span><br><span class="line">  <span class="keyword">if</span> (cL == <span class="keyword">null</span>) &#123;</span><br><span class="line">    cL = Configuration.class.getClassLoader();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hadoop-site.xml 是已经被废弃的配置文件，所以如果 Classpath 中还存在</span></span><br><span class="line">  <span class="comment">// 该文件的话会输出一句 Warning 至日志文件。</span></span><br><span class="line">  <span class="keyword">if</span>(cL.getResource(<span class="string">"hadoop-site.xml"</span>)!=<span class="keyword">null</span>) &#123;</span><br><span class="line">    LOG.warn(<span class="string">"DEPRECATED: hadoop-site.xml found in the classpath. "</span> +</span><br><span class="line">        <span class="string">"Usage of hadoop-site.xml is deprecated. Instead use core-site.xml, "</span></span><br><span class="line">        + <span class="string">"mapred-site.xml and hdfs-site.xml to override properties of "</span> +</span><br><span class="line">        <span class="string">"core-default.xml, mapred-default.xml and hdfs-default.xml "</span> +</span><br><span class="line">        <span class="string">"respectively"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将 core-default.xml、core-site.xml 注册，保存这些默认注册信息的是</span></span><br><span class="line">  <span class="comment">// defaultResources 这个静态变量，它是一个 CopyOnWriteArrayList&lt;String&gt; 对象。</span></span><br><span class="line">  addDefaultResource(<span class="string">"core-default.xml"</span>);</span><br><span class="line">  addDefaultResource(<span class="string">"core-site.xml"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们恍然大悟：原来 <code>core-default.xml</code> 和 <code>core-site.xml</code> 这两个贯穿整个 Hadoop 体系的配置文件就是在这里注册的。所有使用 Configuration 来管理配置的 Hadoop 组件都会注册这两个文件，同时也会根据自己的需求注册数据自己的默认配置文件：例如，HDFS 组件会注册 <code>hdfs-default.xml</code> 和 <code>hdfs-site.xml</code>。这个规律被很多 Hadoop 组件所遵守。</p>
<p>另外，<a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/CopyOnWriteArrayList.html" target="_blank" rel="external">CopyOnWriteArrayList</a> 是一个采用了 <a href="https://en.wikipedia.org/wiki/Copy-on-write" target="_blank" rel="external">Copy on Write</a> 模式的线程安全的 ArrayList，在这里使用是为了保证多线程环境下 Configuration 能够安全地工作。</p>
<p>如果静态初始化代码已经执行过了，则会进一步调用构造方法。这里我们调用了默认构造方法，它的代码很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A new configuration. */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Configuration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 调用重载的构造方法，该方法含有一个指定是否加载默认配置的参数。</span></span><br><span class="line">  <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认构造器调用了指定是否加载默认配置的构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A new configuration where the behavior of reading from the default</span><br><span class="line"> * resources can be turned off.</span><br><span class="line"> *</span><br><span class="line"> * If the parameter &#123;<span class="doctag">@code</span> loadDefaults&#125; is false, the new instance</span><br><span class="line"> * will not load resources from the default files.</span><br><span class="line"> * <span class="doctag">@param</span> loadDefaults specifies whether to load from the default files</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Configuration</span><span class="params">(<span class="keyword">boolean</span> loadDefaults)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 保存是否加载默认配置的值，在后面 Lazy Loading 的时候来判断是否加载默认配置</span></span><br><span class="line">  <span class="keyword">this</span>.loadDefaults = loadDefaults;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// updatingResource 记录了变更的配置项的值以及变更的来源。</span></span><br><span class="line">  updatingResource = <span class="keyword">new</span> ConcurrentHashMap&lt;String, String[]&gt;();</span><br><span class="line">  <span class="keyword">synchronized</span>(Configuration.class) &#123;</span><br><span class="line">    <span class="comment">// REGISTRY 用于记录整个 JVM 进程中所有的 Configuration 对象，从而</span></span><br><span class="line">    <span class="comment">// 在注册新的默认配置的时候可以让每个 Configuration 对象都能及时更新</span></span><br><span class="line">    <span class="comment">// 配置数据</span></span><br><span class="line">    REGISTRY.put(<span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 updatingResource 实例使用了 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentHashMap.html" target="_blank" rel="external">ConcurrentHashMap</a> 来<a href="http://stackoverflow.com/questions/510632/whats-the-difference-between-concurrenthashmap-and-collections-synchronizedmap" target="_blank" rel="external">保证在多线程的环境下的并发访问效率</a>。</p>
<p>REGISTRY 是 Configuration 类的静态成员变量，它是一个 <code>WeakHashMap&lt;Configuration, Object&gt;</code>(<a href="https://docs.oracle.com/javase/7/docs/api/java/util/WeakHashMap.html" target="_blank" rel="external">1</a>、<a href="http://stackoverflow.com/questions/5511279/what-is-a-weakhashmap-and-when-to-use-it" target="_blank" rel="external">2</a>) 对象。在这里只用到了 key set 来保存 JVM 系统中所有存活的 Configuration 对象的引用，从而在默认配置更新的时候能够统一进行配置更新：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Add a default resource. Resources are loaded in the order of the resources</span><br><span class="line"> * added.</span><br><span class="line"> * <span class="doctag">@param</span> name file name. File should be present in the classpath.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addDefaultResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!defaultResources.contains(name)) &#123;</span><br><span class="line">    defaultResources.add(name);</span><br><span class="line">    <span class="keyword">for</span>(Configuration conf : REGISTRY.keySet()) &#123;</span><br><span class="line">      <span class="comment">// 当默认配置项发生变化时，重新加载每个 Configuration 对象的配置数据</span></span><br><span class="line">      <span class="keyword">if</span>(conf.loadDefaults) &#123;</span><br><span class="line">        conf.reloadConfiguration();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化部分的代码并不复杂，需要注意的地方在于并发数据结构的使用。</p>
<h3 id="Lazy-Loading"><a href="#Lazy-Loading" class="headerlink" title="Lazy Loading"></a>Lazy Loading</h3><p>Configuration 不会在 addResource 之后就马上把所有实例的配置源的数据加载一遍，而是会在使用者需要获取某个配置项时再进行加载。这是标准的 Lazy Loading 策略。另，刚才我们已经接触了用于添加默认配置资源的 addDefaultResource 方法，这个方法里面调用了 Configuration 的 reloadConfiguration 方法。从字面意义上理解，这个方法应该重新加载了所有配置资源，但实际上并不是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Reload configuration from previously added resources.</span><br><span class="line"> *</span><br><span class="line"> * This method will clear all the configuration read from the added</span><br><span class="line"> * resources, and final parameters. This will make the resources to</span><br><span class="line"> * be read again before accessing the values. Values that are added</span><br><span class="line"> * via set methods will overlay values read from the resources.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">reloadConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  properties = <span class="keyword">null</span>;                            <span class="comment">// trigger reload</span></span><br><span class="line">  finalParameters.clear();                      <span class="comment">// clear site-limits</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reloadConfiguration 只做了两件事情：将 properties 重置为 null，将 finalParameters 清空。properties 是一个 <code>java.util.Properties</code> 对象，为 Configuration 对象的成员变量。Configuration 加载的所有配置项的值最终都保存在这里。而 finalParameters 则为一个 <code>Set&lt;String&gt;</code> 对象，它记录了那些被标记为 final 的配置项，从而阻止该配置项的值被覆盖掉。</p>
<p>真正发生配置资源加载的时间点是获取配置项值调用 getProps 方法的时候。我们以 get 方法为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the value of the &lt;code&gt;name&lt;/code&gt;. If the key is deprecated,</span><br><span class="line"> * it returns the value of the first key which replaces the deprecated key</span><br><span class="line"> * and is not null.</span><br><span class="line"> * If no such property exists,</span><br><span class="line"> * then &lt;code&gt;defaultValue&lt;/code&gt; is returned.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> name property name, will be trimmed before get value.</span><br><span class="line"> * <span class="doctag">@param</span> defaultValue default value.</span><br><span class="line"> * <span class="doctag">@return</span> property value, or &lt;code&gt;defaultValue&lt;/code&gt; if the property</span><br><span class="line"> *         doesn't exist.                    </span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String name, String defaultValue)</span> </span>&#123;</span><br><span class="line">  String[] names = handleDeprecation(deprecationContext.get(), name);</span><br><span class="line">  String result = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span>(String n : names) &#123;</span><br><span class="line">    <span class="comment">// 获得属性值，并且进行配置项扩展，获得最终结果。</span></span><br><span class="line">    <span class="comment">// getProps 负责加载配置资源的内容，处理后将配置数据保存到 properties 成员变量里面，</span></span><br><span class="line">    <span class="comment">// 然后返回 properties 给调用者。</span></span><br><span class="line">    result = substituteVars(getProps().getProperty(n, defaultValue));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只在需要的时候加载最少的必要的资源，这是 Lazy Loading 的核心思想。</p>
<h3 id="加载、解析配置资源"><a href="#加载、解析配置资源" class="headerlink" title="加载、解析配置资源"></a>加载、解析配置资源</h3><p>刚才遇到的 getProps 方法的实现细节如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> Properties <span class="title">getProps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果 properties 为 null，则证明配置资源还没有加载，否则直接返回它就行。</span></span><br><span class="line">  <span class="keyword">if</span> (properties == <span class="keyword">null</span>) &#123;</span><br><span class="line">    properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="comment">// 因为 loadResources 的过程会改变 updatingResource 的内容，</span></span><br><span class="line">    <span class="comment">// 所以这里通过复制将其备份了一次，以便后面回复 overlay 中配置项的该部分的值。</span></span><br><span class="line">    Map&lt;String, String[]&gt; backup =</span><br><span class="line">        <span class="keyword">new</span> ConcurrentHashMap&lt;String, String[]&gt;(updatingResource);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载所有配置资源，处理其包含的数据，填入到 properties 对象中。</span></span><br><span class="line">    loadResources(properties, resources, quietmode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// overlay 保存了所有经 set 方法设置的配置项的值，</span></span><br><span class="line">    <span class="comment">// 这些值会在获得配置项的时候覆盖掉从配置资源中加载的配置数据，</span></span><br><span class="line">    <span class="comment">// 进而保证最终 properties 中被 set 方法设置的值一定是</span></span><br><span class="line">    <span class="comment">// 当时设置的值，而不受 loadResources 的过程影响。</span></span><br><span class="line">    <span class="comment">// 个人认为这是一个 hack。</span></span><br><span class="line">    <span class="keyword">if</span> (overlay != <span class="keyword">null</span>) &#123;</span><br><span class="line">      properties.putAll(overlay);</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;Object,Object&gt; item: overlay.entrySet()) &#123;</span><br><span class="line">        <span class="comment">// updatingResource 保存了通过 set 方法设置的某个配置项</span></span><br><span class="line">        <span class="comment">// 的来源，因为 loadResources 的过程中可能加载和 overlay 中</span></span><br><span class="line">        <span class="comment">// 配置项同名的配置项，进而引起 updatingResource 中的该配置项</span></span><br><span class="line">        <span class="comment">// 的记录不一致，所以这里需要按照 backup 中的内容修复一下。</span></span><br><span class="line">        String key = (String)item.getKey();</span><br><span class="line">        String[] source = backup.get(key);</span><br><span class="line">        <span class="keyword">if</span>(source != <span class="keyword">null</span>) &#123;</span><br><span class="line">          updatingResource.put(key, source);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> properties;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加载配置资源的动作发生在 loadResources 方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadResources</span><span class="params">(Properties properties,</span><br><span class="line">                           ArrayList&lt;Resource&gt; resources,</span><br><span class="line">                           <span class="keyword">boolean</span> quiet)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// loadDefaults 这个变量在这里其作用了，如果为 true，则加载默认配置资源</span></span><br><span class="line">  <span class="keyword">if</span>(loadDefaults) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String resource : defaultResources) &#123;</span><br><span class="line">      loadResource(properties, <span class="keyword">new</span> Resource(resource), quiet);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//support the hadoop-site.xml as a deprecated case</span></span><br><span class="line">    <span class="keyword">if</span>(getResource(<span class="string">"hadoop-site.xml"</span>)!=<span class="keyword">null</span>) &#123;</span><br><span class="line">      loadResource(properties, <span class="keyword">new</span> Resource(<span class="string">"hadoop-site.xml"</span>), quiet);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载我们通过 addResource 方法注册的配置资源</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; resources.size(); i++) &#123;</span><br><span class="line">    Resource ret = loadResource(properties, resources.get(i), quiet);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="keyword">null</span>) &#123;</span><br><span class="line">      resources.set(i, ret);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以发现，loadResources 方法并没有资源加载的实现细节，具体实现在 loadResource 方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Resource <span class="title">loadResource</span><span class="params">(Properties properties, Resource wrapper, <span class="keyword">boolean</span> quiet)</span> </span>&#123;</span><br><span class="line">  String name = UNKNOWN_RESOURCE;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获得资源以及其名字，资源有多种种类，所以这里用 Object 存储</span></span><br><span class="line">    Object resource = wrapper.getResource();</span><br><span class="line">    name = wrapper.getName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化解析 XML 所需要的组件。</span></span><br><span class="line">    <span class="comment">// 这里开发者选择了一次读取全部内容的 DOM 的解析方式，</span></span><br><span class="line">    <span class="comment">// 这是因为在 Hadoop 的面对的场景下 XML 配置资源所包含的数据</span></span><br><span class="line">    <span class="comment">// 量都很小，一起性全部读到内存中反而实现起来更方便，也不会出现</span></span><br><span class="line">    <span class="comment">// 明显的效率问题。</span></span><br><span class="line">    <span class="comment">// 效率优化的手段是要严格地参考具体的场景来权衡的。</span></span><br><span class="line">    DocumentBuilderFactory docBuilderFactory</span><br><span class="line">      = DocumentBuilderFactory.newInstance();</span><br><span class="line">    <span class="comment">//ignore all comments inside the xml file</span></span><br><span class="line">    docBuilderFactory.setIgnoringComments(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//allow includes in the xml file</span></span><br><span class="line">    <span class="comment">// Hadoop XML 配置是支持 include 机制的，我们</span></span><br><span class="line">    <span class="comment">// 可以在一个配置资源中用 XML 的方式去 include 另一个配置资源。</span></span><br><span class="line">    docBuilderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        docBuilderFactory.setXIncludeAware(<span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedOperationException e) &#123;</span><br><span class="line">      LOG.error(<span class="string">"Failed to set setXIncludeAware(true) for parser "</span></span><br><span class="line">              + docBuilderFactory</span><br><span class="line">              + <span class="string">":"</span> + e,</span><br><span class="line">              e);</span><br><span class="line">    &#125;</span><br><span class="line">    DocumentBuilder builder = docBuilderFactory.newDocumentBuilder();</span><br><span class="line">    Document doc = <span class="keyword">null</span>;</span><br><span class="line">    Element root = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 标志是否返回缓存用的 Properties 对象，当配置资源是 InputStream 类型时为 true。</span></span><br><span class="line">    <span class="keyword">boolean</span> returnCachedProperties = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接下来根据 resource 的类型来对其进行对应的处理。</span></span><br><span class="line">    <span class="comment">// parse 的一系列重载方法具体实现了从某个配置资源将数据</span></span><br><span class="line">    <span class="comment">// 读取并解析的过程。</span></span><br><span class="line">    <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> URL) &#123;                  <span class="comment">// an URL resource</span></span><br><span class="line">      <span class="comment">// 处理 URL 类型的配置资源</span></span><br><span class="line">      doc = parse(builder, (URL)resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> String) &#123;        <span class="comment">// a CLASSPATH resource</span></span><br><span class="line">      <span class="comment">// 处理 String 类型的配置资源，这种情况下 resource 保存了</span></span><br><span class="line">      <span class="comment">// JVM CLASSPATH 中可以寻找到的资源。getResource 方法</span></span><br><span class="line">      <span class="comment">// 会用 class loader 去寻找这个资源并返回。</span></span><br><span class="line">      URL url = getResource((String)resource);</span><br><span class="line">      doc = parse(builder, url);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Path) &#123;          <span class="comment">// a file resource</span></span><br><span class="line">      <span class="comment">// 处理 Path 类型的资源，也就是 HDFS 中的配置资源。</span></span><br><span class="line">      <span class="comment">// Can't use FileSystem API or we get an infinite loop</span></span><br><span class="line">      <span class="comment">// since FileSystem uses Configuration API.  Use java.io.File instead.</span></span><br><span class="line">      File file = <span class="keyword">new</span> File(((Path)resource).toUri().getPath())</span><br><span class="line">        .getAbsoluteFile();</span><br><span class="line">      <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!quiet) &#123;</span><br><span class="line">          LOG.debug(<span class="string">"parsing File "</span> + file);</span><br><span class="line">        &#125;</span><br><span class="line">        doc = parse(builder, <span class="keyword">new</span> BufferedInputStream(</span><br><span class="line">            <span class="keyword">new</span> FileInputStream(file)), ((Path)resource).toString());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> InputStream) &#123;</span><br><span class="line">      <span class="comment">// 处理 InputStream 形式的配置资源。</span></span><br><span class="line">      doc = parse(builder, (InputStream) resource, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 一般情况下 InputStream 类型的配置资源意味着背后很可能是</span></span><br><span class="line">      <span class="comment">// 访问网络这种延时高的、不可靠的动作，而且配置信息在程序运行过程中几乎不会变化，</span></span><br><span class="line">      <span class="comment">// 所以有必要性和可能性将数据读取后保存在一个 Properties 对象中做缓存提高效率。</span></span><br><span class="line">      returnCachedProperties = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Properties) &#123;</span><br><span class="line">      <span class="comment">// 处理 Properties 形式的配置资源。</span></span><br><span class="line">      overlay(properties, (Properties)resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">      <span class="comment">// resource 本身就是 XML 解析结果，无需处理。</span></span><br><span class="line">      root = (Element)resource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (doc == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (quiet) &#123;</span><br><span class="line">          <span class="comment">// quiet 模式下解析失败，直接返回 null。</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非 quiet 模式下解析失败，抛出一个 RuntimeException</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(resource + <span class="string">" not found"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      root = doc.getDocumentElement();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认情况下， toAddTo 就是 this.properties，这意味着后面</span></span><br><span class="line">    <span class="comment">// 将配置项通过 loadProperty 方法写入 toAddTo 时就是更改了</span></span><br><span class="line">    <span class="comment">// this.properties 中的值。</span></span><br><span class="line">    Properties toAddTo = properties;</span><br><span class="line">    <span class="keyword">if</span>(returnCachedProperties) &#123;</span><br><span class="line">      <span class="comment">// 当 resource 是 InputStream 类型时，toAddTo 是一个新的 Properties</span></span><br><span class="line">      <span class="comment">// 对象，这意味着后面 loadProperty 并没有更改 this.properties。</span></span><br><span class="line">      <span class="comment">// 这样做的目的是为了后面将 InputStream 中的配置内容包装成 Resource 返回</span></span><br><span class="line">      <span class="comment">// 给调用者。</span></span><br><span class="line">      toAddTo = <span class="keyword">new</span> Properties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果配置资源中包含的 XML 根节点不是 configuration，则其结构非法，抛出错误。</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"configuration"</span>.equals(root.getTagName()))</span><br><span class="line">      LOG.fatal(<span class="string">"bad conf file: top-level element not &lt;configuration&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 root 节点中的字节点，对其进行迭代并处理。</span></span><br><span class="line">    NodeList props = root.getChildNodes();</span><br><span class="line">    <span class="comment">// 获得被废弃掉的配置项列表。</span></span><br><span class="line">    DeprecationContext deprecations = deprecationContext.get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; props.getLength(); i++) &#123;</span><br><span class="line">      Node propNode = props.item(i);</span><br><span class="line">      <span class="keyword">if</span> (!(propNode <span class="keyword">instanceof</span> Element))</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      Element prop = (Element)propNode;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果子节点的根节点是 configuration，则表示它是一个内嵌的配置组，</span></span><br><span class="line">      <span class="comment">// 所以接下来递归地去处理这部分。</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="string">"configuration"</span>.equals(prop.getTagName())) &#123;</span><br><span class="line">        loadResource(toAddTo, <span class="keyword">new</span> Resource(prop, name), quiet);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 配置项既不是内嵌的 configuration 也不是包含配置信息的 property，抛出警告。</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="string">"property"</span>.equals(prop.getTagName()))</span><br><span class="line">        LOG.warn(<span class="string">"bad conf file: element not &lt;property&gt;"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 配置项是 property，获取其子节点处理之。</span></span><br><span class="line">      NodeList fields = prop.getChildNodes();</span><br><span class="line">      <span class="comment">// 配置的名字，也就是 key。</span></span><br><span class="line">      String attr = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// 配置的值。</span></span><br><span class="line">      String value = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// finalParameter 表明该配置项是否是 final 的。</span></span><br><span class="line">      <span class="keyword">boolean</span> finalParameter = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// source 记载了配置项的来源。</span></span><br><span class="line">      LinkedList&lt;String&gt; source = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; fields.getLength(); j++) &#123;</span><br><span class="line">        Node fieldNode = fields.item(j);</span><br><span class="line">        <span class="keyword">if</span> (!(fieldNode <span class="keyword">instanceof</span> Element))</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        Element field = (Element)fieldNode;</span><br><span class="line">        <span class="comment">// 获取配置项的名称</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"name"</span>.equals(field.getTagName()) &amp;&amp; field.hasChildNodes())</span><br><span class="line">          attr = StringInterner.weakIntern(</span><br><span class="line">              ((Text)field.getFirstChild()).getData().trim());</span><br><span class="line">        <span class="comment">// 获取配置项的值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"value"</span>.equals(field.getTagName()) &amp;&amp; field.hasChildNodes())</span><br><span class="line">          value = StringInterner.weakIntern(</span><br><span class="line">              ((Text)field.getFirstChild()).getData());</span><br><span class="line">        <span class="comment">// 获取配置项的 final 属性</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"final"</span>.equals(field.getTagName()) &amp;&amp; field.hasChildNodes())</span><br><span class="line">          finalParameter = <span class="string">"true"</span>.equals(((Text)field.getFirstChild()).getData());</span><br><span class="line">        <span class="comment">// 获取配置项的 source 属性</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"source"</span>.equals(field.getTagName()) &amp;&amp; field.hasChildNodes())</span><br><span class="line">          source.add(StringInterner.weakIntern(</span><br><span class="line">              ((Text)field.getFirstChild()).getData()));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      source.add(name);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Ignore this parameter if it has already been marked as 'final'</span></span><br><span class="line">      <span class="keyword">if</span> (attr != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果配置项是已经废弃掉的，则将其替换成新的对应的配置项的名字。</span></span><br><span class="line">        <span class="keyword">if</span> (deprecations.getDeprecatedKeyMap().containsKey(attr)) &#123;</span><br><span class="line">          DeprecatedKeyInfo keyInfo =</span><br><span class="line">              deprecations.getDeprecatedKeyMap().get(attr);</span><br><span class="line">          keyInfo.clearAccessed();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (String key : keyInfo.newKeys) &#123;</span><br><span class="line">            <span class="comment">// update new keys with deprecated key's value</span></span><br><span class="line">            <span class="comment">// key 是废弃掉的配置项的 key 替换出来的新的 key，有可能</span></span><br><span class="line">            <span class="comment">// 一个废弃的 key 对应了多个新的 key。</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将替换 key 后的配置项的值填充到 toAddTo 中。</span></span><br><span class="line">            loadProperty(toAddTo, name, key, value, finalParameter,</span><br><span class="line">                source.toArray(<span class="keyword">new</span> String[source.size()]));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 将配置项的值填充到 toAddTo 中</span></span><br><span class="line">          loadProperty(toAddTo, name, attr, value, finalParameter,</span><br><span class="line">              source.toArray(<span class="keyword">new</span> String[source.size()]));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (returnCachedProperties) &#123;</span><br><span class="line">      <span class="comment">// 配置资源是 InputStream，代码运行进入该分支。</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// overlay 方法负责将 toAddTo 中的内容合并到 this.properties 中。</span></span><br><span class="line">      overlay(properties, toAddTo);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将从 InputStream 中读取的内容封装成 Resource 对象后返回，</span></span><br><span class="line">      <span class="comment">// 调用者如果想缓存之，可以自行决定——因为只有调用者了解</span></span><br><span class="line">      <span class="comment">// InputStream 背后的数据源的延时大小、可靠性。</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Resource(toAddTo, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在非 InputStream 类型的配置资源的情况下，不会返回从资源中读取的</span></span><br><span class="line">    <span class="comment">// 配置内容，这些内容已经合并到 this.properties 中去了。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    LOG.fatal(<span class="string">"error parsing conf "</span> + name, e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DOMException e) &#123;</span><br><span class="line">    LOG.fatal(<span class="string">"error parsing conf "</span> + name, e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (SAXException e) &#123;</span><br><span class="line">    LOG.fatal(<span class="string">"error parsing conf "</span> + name, e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ParserConfigurationException e) &#123;</span><br><span class="line">    LOG.fatal(<span class="string">"error parsing conf "</span> + name , e);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadResource 方法中用 loadProperty 将某个配置项加入到 Properties 对象中，用 overlay 方法来将某个 Properties 对象的值合并到另一个里面去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// name 是配置资源的名字，而不是配置项的 key，attr 才是。</span></span><br><span class="line"><span class="comment">// finalParameter 表明了该配置项是否是不可更改的。</span></span><br><span class="line"><span class="comment">// source 表明了该配置项从哪里来。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadProperty</span><span class="params">(Properties properties, String name, String attr,</span><br><span class="line">    String value, <span class="keyword">boolean</span> finalParameter, String[] source)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (value != <span class="keyword">null</span> || allowNullValueProperties) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!finalParameters.contains(attr)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (value==<span class="keyword">null</span> &amp;&amp; allowNullValueProperties) &#123;</span><br><span class="line">        <span class="comment">// 如果 value 为 null 而配置允许空值，则赋予一个约定好的</span></span><br><span class="line">        <span class="comment">// 常量表示该配置项的值为空。</span></span><br><span class="line">        value = DEFAULT_STRING_CHECK;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 填入配置项的值。</span></span><br><span class="line">      properties.setProperty(attr, value);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 标记配置项的来源。</span></span><br><span class="line">      <span class="keyword">if</span>(source != <span class="keyword">null</span>) &#123;</span><br><span class="line">        updatingResource.put(attr, source);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!value.equals(properties.getProperty(attr))) &#123;</span><br><span class="line">      <span class="comment">// 要更改 final 属性的配置项，在 log 中输出 warning。</span></span><br><span class="line">      LOG.warn(name+<span class="string">":an attempt to override final parameter: "</span>+attr</span><br><span class="line">          +<span class="string">";  Ignoring."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果配置项为 final，则将其标记之供下次有人要更改时判断。</span></span><br><span class="line">  <span class="keyword">if</span> (finalParameter &amp;&amp; attr != <span class="keyword">null</span>) &#123;</span><br><span class="line">    finalParameters.add(attr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 from 中的值合并到 to 中。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">overlay</span><span class="params">(Properties to, Properties from)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (Entry&lt;Object, Object&gt; entry: from.entrySet()) &#123;</span><br><span class="line">    to.put(entry.getKey(), entry.getValue());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的 XML 解析发生在 parse 方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个方法是对另一个 InputStream 接口的方法的封装，比较简单。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Document <span class="title">parse</span><span class="params">(DocumentBuilder builder, URL url)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, SAXException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!quietmode) &#123;</span><br><span class="line">    <span class="comment">// 非 quietmode，输出日志。</span></span><br><span class="line">    LOG.debug(<span class="string">"parsing URL "</span> + url);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (url == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> parse(builder, url.openStream(), url.toString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析 InputStream 中的内容，返回解析好的 org.w3c.dom.Document 对象。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Document <span class="title">parse</span><span class="params">(DocumentBuilder builder, InputStream is,</span><br><span class="line">    String systemId)</span> <span class="keyword">throws</span> IOException, SAXException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!quietmode) &#123;</span><br><span class="line">    <span class="comment">// 非 quietmode，输出日志。</span></span><br><span class="line">    LOG.debug(<span class="string">"parsing input stream "</span> + is);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (systemId == <span class="keyword">null</span>) ? builder.parse(is) : builder.parse(is,</span><br><span class="line">        systemId);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    is.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置项扩展"><a href="#配置项扩展" class="headerlink" title="配置项扩展"></a>配置项扩展</h3><p>在 Lazy Loading 那部分我们接触到了 get 方法的实现，其中使用了 substituteVars 方法来对配置项进行扩展，其实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Attempts to repeatedly expand the value &#123;<span class="doctag">@code</span> expr&#125; by replacing the</span><br><span class="line"> * left-most substring of the form "$&#123;var&#125;" in the following precedence order</span><br><span class="line"> * &lt;ol&gt;</span><br><span class="line"> *   &lt;li&gt;by the value of the Java system property "var" if defined&lt;/li&gt;</span><br><span class="line"> *   &lt;li&gt;by the value of the configuration key "var" if defined&lt;/li&gt;</span><br><span class="line"> * &lt;/ol&gt;</span><br><span class="line"> *</span><br><span class="line"> * If var is unbounded the current state of expansion "prefix$&#123;var&#125;suffix" is</span><br><span class="line"> * returned.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> expr the literal value of a config key</span><br><span class="line"> * <span class="doctag">@return</span> null if expr is null, otherwise the value resulting from expanding</span><br><span class="line"> * expr using the algorithm above.</span><br><span class="line"> * <span class="doctag">@throws</span> IllegalArgumentException when more than</span><br><span class="line"> * &#123;<span class="doctag">@link</span> Configuration#MAX_SUBST&#125; replacements are required</span><br><span class="line"> */</span></span><br><span class="line"> <span class="comment">// 这个方法负责配置项的扩展。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">substituteVars</span><span class="params">(String expr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (expr == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String eval = expr;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一次循环代表了一次扩展：这是因为有可能扩展完毕的结果有可能还存在一个未扩展的值。</span></span><br><span class="line">  <span class="comment">// MAX_SUBST 是 Hadoop 开发者实现定义好的常量，默认为 20，代表对一个配置项</span></span><br><span class="line">  <span class="comment">// 最多进行 20 次扩展。通常情况下已经够用了。</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> s = <span class="number">0</span>; s &lt; MAX_SUBST; s++) &#123;</span><br><span class="line">    <span class="comment">// 找到「$」、「&#123;」、「&#125;」这些符号是否存在，以及都在 eval 的哪里。</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] varBounds = findSubVariable(eval);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (varBounds[SUB_START_IDX] == -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 没有找到 $&#123;foobar&#125; 这样的结构，直接返回。</span></span><br><span class="line">      <span class="keyword">return</span> eval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到了 $&#123;foobar&#125;，将其 key 提取出来——也就是提取出 foobar。</span></span><br><span class="line">    <span class="keyword">final</span> String var = eval.substring(varBounds[SUB_START_IDX],</span><br><span class="line">        varBounds[SUB_END_IDX]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// val 就是扩展后的值。</span></span><br><span class="line">    String val = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 优先从系统默认的属性中获取扩展配置。</span></span><br><span class="line">      val = System.getProperty(var);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(SecurityException se) &#123;</span><br><span class="line">      LOG.warn(<span class="string">"Unexpected SecurityException in Configuration"</span>, se);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 系统默认的配置中没有，则从已经加载的配置内容中获取扩展配置。</span></span><br><span class="line">      val = getRaw(var);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 最终没有找到要扩展的配置项，这个时候保留 $&#123;foobar&#125; 不动继续。</span></span><br><span class="line">      <span class="keyword">return</span> eval; <span class="comment">// return literal $&#123;var&#125;: var is unbound</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得「$」符号的 index。</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> dollar = varBounds[SUB_START_IDX] - <span class="string">"$&#123;"</span>.length();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得「&#125;」符号后一个字符的 index。</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> afterRightBrace = varBounds[SUB_END_IDX] + <span class="string">"&#125;"</span>.length();</span><br><span class="line">    <span class="comment">// substitute</span></span><br><span class="line">    <span class="comment">// 将 $&#123;foobar&#125; 整个替换为找到的那个值。</span></span><br><span class="line">    eval = eval.substring(<span class="number">0</span>, dollar)</span><br><span class="line">           + val</span><br><span class="line">           + eval.substring(afterRightBrace);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Variable substitution depth too large: "</span></span><br><span class="line">                                  + MAX_SUBST + <span class="string">" "</span> + expr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * This is a manual implementation of the following regex</span><br><span class="line"> * "\\$\\&#123;[^\\&#125;\\$\u0020]+\\&#125;". It can be 15x more efficient than</span><br><span class="line"> * a regex matcher as demonstrated by HADOOP-11506. This is noticeable with</span><br><span class="line"> * Hadoop apps building on the assumption Configuration#get is an O(1)</span><br><span class="line"> * hash table lookup, especially when the eval is a long string.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> eval a string that may contain variables requiring expansion.</span><br><span class="line"> * <span class="doctag">@return</span> a 2-element int array res such that</span><br><span class="line"> * eval.substring(res[0], res[1]) is "var" for the left-most occurrence of</span><br><span class="line"> * $&#123;var&#125; in eval. If no variable is found -1, -1 is returned.</span><br><span class="line"> */</span></span><br><span class="line"> <span class="comment">// 这个方法负责寻找配置项的值中的「$」「[」「]」符号的位置。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] findSubVariable(String eval) &#123;</span><br><span class="line">  <span class="keyword">int</span>[] result = &#123;-<span class="number">1</span>, -<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> matchStart;</span><br><span class="line">  <span class="keyword">int</span> leftBrace;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// scanning for a brace first because it's less frequent than $</span></span><br><span class="line">  <span class="comment">// that can occur in nested class names</span></span><br><span class="line">  <span class="comment">// 因为 Java 内部类的名字中存在「$」符号，所以实现中并不优先寻找该符号，而是寻找</span></span><br><span class="line">  <span class="comment">// 在配置扩展场景中更为常见的「[」符号。这体现了按照场景和统计情况来做优化的思路。</span></span><br><span class="line">  match_loop:</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (matchStart = <span class="number">1</span>, leftBrace = eval.indexOf(<span class="string">'&#123;'</span>, matchStart);</span><br><span class="line">       <span class="comment">// minimum left brace position (follows '$')</span></span><br><span class="line">       leftBrace &gt; <span class="number">0</span></span><br><span class="line">       <span class="comment">// right brace of a smallest valid expression "$&#123;c&#125;"</span></span><br><span class="line">       <span class="comment">// 配置项至少是 $&#123;c&#125; 这样的形式，也就是说 key 长度至少为 1。</span></span><br><span class="line">       &amp;&amp; leftBrace + <span class="string">"&#123;c"</span>.length() &lt; eval.length();</span><br><span class="line">       <span class="comment">// 类似于 KMP 算法的思路，这里每次往前跳的位数是尽可能大的而不是仅仅一位。</span></span><br><span class="line">       <span class="comment">// 这是一个优化的手段。</span></span><br><span class="line">       leftBrace = eval.indexOf(<span class="string">'&#123;'</span>, matchStart)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> matchedLen = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果「&#123;」符号的左边是「$」符号，则表明发现了一个需要扩展的地方。</span></span><br><span class="line">    <span class="keyword">if</span> (eval.charAt(leftBrace - <span class="number">1</span>) == <span class="string">'$'</span>) &#123;</span><br><span class="line">      <span class="comment">// 扩展配置项 key 起始的位置。</span></span><br><span class="line">      <span class="keyword">int</span> subStart = leftBrace + <span class="number">1</span>; <span class="comment">// after '&#123;'</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 寻找 key 起始位置最靠近的右边的「&#125;」符号从而确定 key 的终点。</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = subStart; i &lt; eval.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (eval.charAt(i)) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'&#125;'</span>:</span><br><span class="line">            <span class="comment">// 找到了。</span></span><br><span class="line">            <span class="keyword">if</span> (matchedLen &gt; <span class="number">0</span>) &#123; <span class="comment">// match</span></span><br><span class="line">              result[SUB_START_IDX] = subStart;</span><br><span class="line">              result[SUB_END_IDX] = subStart + matchedLen;</span><br><span class="line">              <span class="comment">// 使用标志点退出大循环。</span></span><br><span class="line">              <span class="keyword">break</span> match_loop;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// fall through to skip 1 char</span></span><br><span class="line">          <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">'$'</span>:</span><br><span class="line">            <span class="comment">// 发现扩展配置项中还包含可扩展的配置项，开始优先获取该扩展项的 key。</span></span><br><span class="line">            matchStart = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span> match_loop;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            matchedLen++;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// scanned from "$&#123;"  to the end of eval, and no reset via ' ', '$':</span></span><br><span class="line">      <span class="comment">//    no match!</span></span><br><span class="line">      <span class="keyword">break</span> match_loop;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// not a start of a variable</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      matchStart = leftBrace + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最终返回的是符合要求的扩展配置的 key 的开始、结尾在 eval 中的 index。</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上配置扩展的逻辑并不复杂，用流程图可以总结如下：</p>
<p><img src="http://o9fv3ui6e.bkt.clouddn.com/f688fcdc-4380-11e6-89c1-9707c159c204.svg" alt="State Diagram for Config Expansion"></p>
<p><strong>理解一个事物的最佳实践之一就是举一个恰当的例子</strong>。我们以扩展下面配置数据中的 config4 为例子：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>config1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>R.I.P<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>starman<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>config2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;config1&#125;,David<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>config3<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;config2&#125;Bowie<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>config4<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;config3&#125;.<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最终按照之前的逻辑扩展完毕后，config4 的值为<code>R.I.P,DavidBowie.</code>。</p>
<p>一个需要注意的问题是配置扩展最多允许 20 次<code>迭代</code>，过多的话会保留原样返回。这个是由 <code>Configuration.MAX_SUBST</code> 这个变量来决定的，一般情况下 20 次扩展机会已经绰绰有余了。比较特殊的情况是下面这种循环扩展的情况：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>foo$&#123;bar&#125;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;foo&#125;bar<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果尝试去获取 foo 的值，配置会被扩展 20 次后返回一个包含 <code>${foo}</code> 的字符串——因为没有使用递归的实现策略，Stack Overflow 的情况并不会发生。<code>除非你十分确定编译器/解释器对你的递归程序有确定行为的优化，严肃的生产环境下一定要谨慎使用递归。</code></p>
<h3 id="获取配置项的值"><a href="#获取配置项的值" class="headerlink" title="获取配置项的值"></a>获取配置项的值</h3><p>通过前面几个部分，实际上我们对获取某个配置项的值的过程实际上已经比较明确了。这里我们再进一步研究一下获得某种类型的配置项的值的过程。我们以 getInt 为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the value of the &lt;code&gt;name&lt;/code&gt; property as an &lt;code&gt;int&lt;/code&gt;.</span><br><span class="line"> *   </span><br><span class="line"> * If no such property exists, the provided default value is returned,</span><br><span class="line"> * or if the specified value is not a valid &lt;code&gt;int&lt;/code&gt;,</span><br><span class="line"> * then an error is thrown.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> name property name.</span><br><span class="line"> * <span class="doctag">@param</span> defaultValue default value.</span><br><span class="line"> * <span class="doctag">@throws</span> NumberFormatException when the value is invalid</span><br><span class="line"> * <span class="doctag">@return</span> property value as an &lt;code&gt;int&lt;/code&gt;,</span><br><span class="line"> *         or &lt;code&gt;defaultValue&lt;/code&gt;.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(String name, <span class="keyword">int</span> defaultValue)</span> </span>&#123;</span><br><span class="line">  String valueString = getTrimmed(name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (valueString == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">return</span> defaultValue;</span><br><span class="line"></span><br><span class="line">  String hexString = getHexDigits(valueString);</span><br><span class="line">  <span class="comment">// 是 16 进制的数字，按照 16 进制的方式进行转化。</span></span><br><span class="line">  <span class="keyword">if</span> (hexString != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.parseInt(hexString, <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是普通的 10 进制数字，按照普通的方式转化。</span></span><br><span class="line">  <span class="keyword">return</span> Integer.parseInt(valueString);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Get the value of the &lt;code&gt;name&lt;/code&gt; property as a trimmed &lt;code&gt;String&lt;/code&gt;,</span><br><span class="line"> * &lt;code&gt;null&lt;/code&gt; if no such property exists.</span><br><span class="line"> * If the key is deprecated, it returns the value of</span><br><span class="line"> * the first key which replaces the deprecated key and is not null</span><br><span class="line"> *</span><br><span class="line"> * Values are processed for &lt;a href="#VariableExpansion"&gt;variable expansion&lt;/a&gt;</span><br><span class="line"> * before being returned.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> name the property name.</span><br><span class="line"> * <span class="doctag">@return</span> the value of the &lt;code&gt;name&lt;/code&gt; or its replacing property,</span><br><span class="line"> *         or null if no such property exists.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTrimmed</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// get 方法我们前面已经介绍过了。</span></span><br><span class="line">  String value = get(name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> == value) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 去除掉字符串两边的空白字符。</span></span><br><span class="line">    <span class="keyword">return</span> value.trim();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断并进一步将字符串类型转化为 16 进制形式的字符串以方便进一步转化为 Integer。</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getHexDigits</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> negative = <span class="keyword">false</span>;</span><br><span class="line">  String str = value;</span><br><span class="line">  String hexString = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果以「-」符号开头，表示其为负数。</span></span><br><span class="line">  <span class="keyword">if</span> (value.startsWith(<span class="string">"-"</span>)) &#123;</span><br><span class="line">    negative = <span class="keyword">true</span>;</span><br><span class="line">    str = value.substring(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 去掉打头的「0x」或「0X」，只拿数字部分。</span></span><br><span class="line">  <span class="keyword">if</span> (str.startsWith(<span class="string">"0x"</span>) || str.startsWith(<span class="string">"0X"</span>)) &#123;</span><br><span class="line">    hexString = str.substring(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (negative) &#123;</span><br><span class="line">      hexString = <span class="string">"-"</span> + hexString;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hexString;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不是 16 进制的数字，返回 null。</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到整个流程并不复杂，主要是考虑到了一些进制、空白字符等问题。其他类似的方法也是类似的流程。</p>
<h3 id="设置配置项的值"><a href="#设置配置项的值" class="headerlink" title="设置配置项的值"></a>设置配置项的值</h3><p>设置配置项的值的接口和获取配置项的值的接口类似，存在一个通用的 set 方法和类型特有的类似与 setInt 这样的方法。我们先研究 set 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the &lt;code&gt;value&lt;/code&gt; of the &lt;code&gt;name&lt;/code&gt; property. If</span><br><span class="line"> * &lt;code&gt;name&lt;/code&gt; is deprecated, it also sets the &lt;code&gt;value&lt;/code&gt; to</span><br><span class="line"> * the keys that replace the deprecated key. Name will be trimmed before put</span><br><span class="line"> * into configuration.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> name property name.</span><br><span class="line"> * <span class="doctag">@param</span> value property value.</span><br><span class="line"> * <span class="doctag">@param</span> source the place that this configuration value came from</span><br><span class="line"> * (For debugging).</span><br><span class="line"> * <span class="doctag">@throws</span> IllegalArgumentException when the value or name is null.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String name, String value, String source)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 先做必要的参数检测。</span></span><br><span class="line">  Preconditions.checkArgument(</span><br><span class="line">      name != <span class="keyword">null</span>,</span><br><span class="line">      <span class="string">"Property name must not be null"</span>);</span><br><span class="line">  Preconditions.checkArgument(</span><br><span class="line">      value != <span class="keyword">null</span>,</span><br><span class="line">      <span class="string">"The value of property "</span> + name + <span class="string">" must not be null"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 去除掉两端多余的空白字符。</span></span><br><span class="line">  name = name.trim();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取废弃掉的配置项的新旧 key 对照表。</span></span><br><span class="line">  DeprecationContext deprecations = deprecationContext.get();</span><br><span class="line">  <span class="keyword">if</span> (deprecations.getDeprecatedKeyMap().isEmpty()) &#123;</span><br><span class="line">    getProps();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 this.overlay 和 this.properties 中分别写入配置项。</span></span><br><span class="line">  getOverlay().setProperty(name, value);</span><br><span class="line">  getProps().setProperty(name, value);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果必要，设置默认 source。</span></span><br><span class="line">  String newSource = (source == <span class="keyword">null</span> ? <span class="string">"programatically"</span> : source);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isDeprecated(name)) &#123;</span><br><span class="line">    <span class="comment">// 配置项没有废弃掉，则记录其来源。</span></span><br><span class="line">    updatingResource.put(name, <span class="keyword">new</span> String[] &#123;newSource&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有可能该配置项存在其他名字但意义等同的配置项，存在的话</span></span><br><span class="line">    <span class="comment">// 在一一将其设置为现在要设置的值。</span></span><br><span class="line">    String[] altNames = getAlternativeNames(name);</span><br><span class="line">    <span class="keyword">if</span>(altNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span>(String n: altNames) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!n.equals(name)) &#123;</span><br><span class="line">          getOverlay().setProperty(n, value);</span><br><span class="line">          getProps().setProperty(n, value);</span><br><span class="line">          updatingResource.put(n, <span class="keyword">new</span> String[] &#123;newSource&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是已经废弃掉的 key，则将其替换为新的对应的 key 再写入一遍。</span></span><br><span class="line">    String[] names = handleDeprecation(deprecationContext.get(), name);</span><br><span class="line">    String altSource = <span class="string">"because "</span> + name + <span class="string">" is deprecated"</span>;</span><br><span class="line">    <span class="keyword">for</span>(String n : names) &#123;</span><br><span class="line">      getOverlay().setProperty(n, value);</span><br><span class="line">      getProps().setProperty(n, value);</span><br><span class="line">      updatingResource.put(n, <span class="keyword">new</span> String[] &#123;altSource&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在前面的部分我们介绍过 overlay 变量保存了通过 set 方法设置的配置项的值，并保证最终获取配置项的时候，通过 set 方法设置的值不会被配置资源中原有的该配置项的值覆盖掉。</p>
<p>接下来我们去了解一下为某个类型定制的 set 方法。我们以 setInt 为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the value of the &lt;code&gt;name&lt;/code&gt; property to an &lt;code&gt;int&lt;/code&gt;.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> name property name.</span><br><span class="line"> * <span class="doctag">@param</span> value &lt;code&gt;int&lt;/code&gt; value of the property.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(String name, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">  set(name, Integer.toString(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的情况比 getInt 要简单：直接将 value 转化为正确的 String 类型后再调用 set 方法即可。</p>
<h2 id="跋"><a href="#跋" class="headerlink" title="跋"></a>跋</h2><p>至此，Configuration 核心部分的逻辑及实现细节我们已经总结完毕了，剩下的类似于「替换废弃掉的 key」这样的非主要部分的实现，读者可以自行前往<a href="https://github.com/apache/hadoop/blob/branch-2.7.2/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/conf/Configuration.java" target="_blank" rel="external">源码处</a>进一步了解。<code>复杂的软件并不是玄而又玄的东西，深入地去了解，它们实际上都是由很简单的思维、方法、实践组合、发展起来的</code>。</p>
<p>如果您作为读者有什么疑问、错误需要讨论、指出的话，欢迎留言。</p>
<embed src="http://www.xiami.com/widget/0_1769863606/singlePlayer.swf" type="application/x-shockwave-flash" width="257" height="33" wmode="transparent">
</div></article></div></section><footer><div class="paginator"><a href="/2016/07/07/octotree-plugin-for-github-in-chrome/" class="prev">上一篇</a><a href="/2015/11/24/annotations-on-paper-trail-columnar-storage/" class="next">下一篇</a></div><div data-thread-key="2016/06/10/configuration-in-hadoop/" data-title="Hadoop 中的 Configuration" data-url="http://bachiscoding.com/2016/06/10/configuration-in-hadoop/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"bachiscoding"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://bachiscoding.com">winiex</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>